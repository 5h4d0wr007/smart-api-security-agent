name: OpenAPI → Security tests with Postman MCP

on:
  pull_request:
    paths:
      - "openapi/**.y*ml"
      - "openapi/**.json"
      - "app/**"
      - "tools/**"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  # US MCP only (can be overridden in repo variables if you want)
  POSTMAN_MCP_URL: ${{ vars.POSTMAN_MCP_URL || 'https://mcp.postman.com/mcp' }}
  POSTMAN_WORKSPACE_NAME: ${{ vars.POSTMAN_WORKSPACE_NAME || 'Security Demo' }}
  POSTMAN_ENV_NAME: ${{ vars.POSTMAN_ENV_NAME || 'Security Demo Env' }}
  POSTMAN_CLI_DISABLE_TELEMETRY: "true"

jobs:
  test-on-openapi-change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Gate secrets (so forks don't fail)
      - name: Discover secrets availability (gate for forks)
        id: gates
        shell: bash
        run: |
          has_openai=false
          has_postman=false
          [ -n "${{ secrets.OPENAI_API_KEY }}" ]  && has_openai=true
          [ -n "${{ secrets.POSTMAN_API_KEY }}" ] && has_postman=true
          if $has_openai && $has_postman; then
            echo "has_secrets=true"  >> "$GITHUB_OUTPUT"
          else
            echo "has_secrets=false" >> "$GITHUB_OUTPUT"
          fi
          echo "has_openai=$has_openai"
          echo "has_postman=$has_postman"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node (for swagger-cli)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install openai requests

      - name: Install CLI tooling (Postman CLI + swagger-cli)
        run: |
          # Postman CLI (official)
          curl -fsSL "https://dl-cli.pstmn.io/install/linux64.sh" | sh
          # OpenAPI validator
          npm i -g @apidevtools/swagger-cli@4
          postman --version
          swagger-cli --version

      - name: Install oasdiff (Linux binary, pinned)
        run: |
          set -euo pipefail
          OASDIFF_VERSION="v1.10.28"
          TARBALL="oasdiff_${OASDIFF_VERSION#v}_Linux_x86_64.tar.gz"
          URL_PRIMARY="https://github.com/Tufin/oasdiff/releases/download/${OASDIFF_VERSION}/${TARBALL}"
          URL_FALLBACK="https://github.com/oasdiff/oasdiff/releases/download/${OASDIFF_VERSION}/${TARBALL}"
          echo "Downloading oasdiff ${OASDIFF_VERSION}…"
          if ! curl -fL "$URL_PRIMARY" -o oasdiff.tgz; then
            echo "Primary URL failed, trying fallback…"
            curl -fL "$URL_FALLBACK" -o oasdiff.tgz
          fi
          tar -xzf oasdiff.tgz oasdiff
          sudo mv oasdiff /usr/local/bin/oasdiff
          sudo chmod +x /usr/local/bin/oasdiff
          oasdiff --help >/dev/null

      - name: Start sample app (localhost:8000)
        env:
          # Always run in vulnerable mode by default
          VULN_PROFILE: demo
        run: |
          python app/app.py &
          echo $! > app.pid
          # Warm up until server responds
          for i in {1..20}; do
            if curl -fsSI http://127.0.0.1:8000/ >/dev/null 2>&1; then
              echo "App is up"
              break
            fi
            sleep 1
          done

      - name: Compute OpenAPI diff (base vs head)
        run: |
          set -euo pipefail
          BASE=origin/${{ github.base_ref }}
          HEAD=origin/${{ github.head_ref }}
          mkdir -p .tmp
          FILE=$(git diff --name-only "$BASE...$HEAD" | grep -E '^openapi/.*\.(ya?ml|json)$' | head -n1 || true)
          if [ -z "${FILE:-}" ]; then
            echo "No OpenAPI changes detected; diffing defaults."
            cp openapi/api.v1.yaml .tmp/base.yaml || true
            cp openapi/api.yaml    .tmp/head.yaml
          else
            git show "$BASE:$FILE" > .tmp/base.yaml || cp openapi/api.v1.yaml .tmp/base.yaml
            git show "$HEAD:$FILE" > .tmp/head.yaml || cp openapi/api.yaml    .tmp/head.yaml
          fi
          swagger-cli validate .tmp/base.yaml
          swagger-cli validate .tmp/head.yaml
          oasdiff diff --format json .tmp/base.yaml .tmp/head.yaml > diff.json
          echo "Wrote diff.json"

      - name: LLM → plan & create/overwrite collection via official Postman MCP
        if: steps.gates.outputs.has_secrets == 'true'
        env:
          OPENAI_API_KEY:  ${{ secrets.OPENAI_API_KEY }}
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_MCP_URL: ${{ env.POSTMAN_MCP_URL }}
          POSTMAN_WORKSPACE_NAME: ${{ env.POSTMAN_WORKSPACE_NAME }}
          POSTMAN_ENV_NAME: ${{ env.POSTMAN_ENV_NAME }}
        run: |
          python tools/agent_openapi_to_postman.py \
            --base openapi/api.v1.yaml \
            --head openapi/api.yaml \
            --diff diff.json \
            --collection "security test collection" \
            --plan plan.json
          test -f generated-security-test.postman_collection.json

      - name: Explain why LLM/Postman steps were skipped
        if: steps.gates.outputs.has_secrets != 'true'
        run: |
          echo "::warning::Secrets not available (likely a forked PR). Skipping LLM/MCP/Postman run. The workflow still runs so you can see status, but no SARIF will be uploaded."

      - name: Postman CLI login (non-interactive)
        if: steps.gates.outputs.has_secrets == 'true'
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          postman login --with-api-key "$POSTMAN_API_KEY"

      - name: Run generated collection with Postman CLI (JSON reporter)
        if: steps.gates.outputs.has_secrets == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          postman collection run ./generated-security-test.postman_collection.json \
            --reporters cli,json \
            --reporter-json-export run.json \
          || true
          # ensure run.json exists even if Postman bailed early
          if [ ! -f run.json ]; then
            echo '{"run":{"failures":[],"executions":[],"stats":{"assertions":{"total":0,"failed":0}}}}' > run.json
          fi
          ls -l run.json

      - name: Convert Postman report → SARIF
        if: steps.gates.outputs.has_secrets == 'true'
        run: |
          python tools/cli_report_to_sarif.py run.json sarif.json
          python - <<'PY'
import json
d=json.load(open('sarif.json'))
print("SARIF results:", len(d.get("runs",[{}])[0].get("results",[])))
PY

      # Upload SARIF only when PR comes from same repo (GitHub permissions)
      - name: Upload SARIF to GitHub Code Scanning
        if: steps.gates.outputs.has_secrets == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif.json
          category: postman-security

      # Optional: sticky PR comment summarizing findings (only same-repo PRs can be commented)
      - name: Build PR comment from SARIF
        if: steps.gates.outputs.has_secrets == 'true' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          python - <<'PY'
import json, pathlib
d=json.load(open('sarif.json'))
res=d.get('runs',[{}])[0].get('results',[])
lines=["**Postman Security Test Agent — Findings**"]
if not res:
  lines.append("\n> ✅ No security test failures detected")
else:
  lines.append("\n|  | Level | Finding |")
  lines.append("|---|---|---|")
  sev = {"error":"❌","warning":"⚠️","note":"ℹ️"}
  for r in res:
    lvl = r.get("level","note")
    msg = r.get("message",{}).get("text","(no message)").replace("\n"," ")[:300]
    lines.append(f"| {sev.get(lvl,'❔')} | {lvl} | {msg} |")
  lines.append("\n_Artifacts: `diff.json`, `plan.json`, `run.json`, `sarif.json`, and the generated collection._")
pathlib.Path('sarif_comment.md').write_text("\n".join(lines))
PY

      - name: Post sticky PR comment
        if: steps.gates.outputs.has_secrets == 'true' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: marocchino/sticky-pull-request-comment@v3
        with:
          header: Postman Security Summary
          path: sarif_comment.md

      - name: Upload artifacts (diff, plan, run, sarif, collection)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-security-output
          path: |
            diff.json
            plan.json
            run.json
            sarif.json
            generated-security-test.postman_collection.json

      - name: Stop sample app
        if: always()
        run: |
          kill "$(cat app.pid)" 2>/dev/null || true
