name: OpenAPI → Postman MCP → Security tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write   # required for SARIF upload

jobs:
  api-security:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      POSTMAN_MCP_URL: https://mcp.postman.com/mcp
      POSTMAN_WORKSPACE_NAME: Security Demo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          set -e
          # swagger-cli (deprecation warning is fine for our use)
          npm install -g @apidevtools/swagger-cli

          # jq/curl
          sudo apt-get update -y
          sudo apt-get install -y jq curl

          # ----- oasdiff (correct release asset, arch-aware) -----
          OASDIFF_VERSION=1.10.28
          UNAME_ARCH="$(uname -m)"
          if [ "$UNAME_ARCH" = "x86_64" ]; then
            OAS_ASSET="oasdiff_${OASDIFF_VERSION}_Linux_x86_64.tar.gz"
          elif [ "$UNAME_ARCH" = "aarch64" ]; then
            OAS_ASSET="oasdiff_${OASDIFF_VERSION}_Linux_arm64.tar.gz"
          else
            echo "Unsupported arch: $UNAME_ARCH"; exit 1
          fi
          curl -fsSL -o oasdiff.tgz "https://github.com/Tufin/oasdiff/releases/download/v${OASDIFF_VERSION}/${OAS_ASSET}"
          tar -xzf oasdiff.tgz oasdiff
          sudo mv oasdiff /usr/local/bin/oasdiff
          sudo chmod +x /usr/local/bin/oasdiff
          oasdiff --help >/dev/null

          # Python libs
          python -m pip install --upgrade pip
          pip install requests openai

      - name: Start sample app (localhost:8000)
        run: |
          pip install flask
          python app/app.py &
          echo $! > app.pid
          # Give it a moment to bind
          sleep 2

      - name: Compute OpenAPI diff (base vs head)
        run: |
          set -euo pipefail
          cp openapi/api.v1.yaml .tmp.base.yaml || true
          cp openapi/api.yaml    .tmp.head.yaml
          swagger-cli validate .tmp.base.yaml
          swagger-cli validate .tmp.head.yaml
          oasdiff diff --format json .tmp.base.yaml .tmp.head.yaml > diff.json
          echo "Wrote diff.json"

      - name: LLM → plan & create/overwrite collection via Postman MCP
        run: |
          python tools/agent_openapi_to_postman.py --base openapi/api.v1.yaml --head openapi/api.yaml
          test -f generated-security-test.postman_collection.json

      - name: Postman CLI login (non-interactive)
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          postman login --with-api-key "$POSTMAN_API_KEY"

      - name: Run generated collection with Postman CLI (JSON reporter)
        # keep job green so SARIF conversion + upload always run
        continue-on-error: true
        run: |
          postman collection run ./generated-security-test.postman_collection.json \
            --reporters cli,json \
            --reporter-json-export run.json \
          || true

      - name: Convert Postman report → SARIF
        run: |
          python tools/cli_report_to_sarif.py run.json sarif.json
          echo "Preview:"
          python - <<'PY'
import json; 
j=json.load(open('sarif.json')); 
print("results:", len(j.get("runs",[{}])[0].get("results",[])))
PY

      # Upload SARIF results to Code scanning. 
      # Skip for forked PRs to avoid permission errors.
      - name: Upload SARIF to GitHub Code Scanning
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif.json
          category: openapi-postman-security
          commit_sha: ${{ github.event.pull_request.head.sha || github.sha }}
          ref:        ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Upload artifacts (diff, plan, run, sarif, collection)
        uses: actions/upload-artifact@v4
        with:
          name: api-security-output
          path: |
            diff.json
            plan.json
            run.json
            sarif.json
            generated-security-test.postman_collection.json

      - name: Stop app
        if: always()
        run: |
          if [ -f app.pid ]; then kill $(cat app.pid) || true; fi
